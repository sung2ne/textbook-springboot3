<!-- 수정: src/main/resources/templates/boards/detail.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title th:text="${board.title}">게시글 상세</title>
</head>
<body>
<main layout:fragment="content">
    <article>
        <!-- 제목 -->
        <h2 th:text="${board.title}">제목</h2>

        <!-- 메타 정보 -->
        <div class="d-flex justify-content-between text-muted border-bottom pb-2 mb-4">
            <div>
                <span th:text="${board.writerName}">작성자</span>
                <span class="mx-2">|</span>
                <span th:text="${#temporals.format(board.createdAt, 'yyyy-MM-dd HH:mm')}">작성일</span>
                <span th:if="${board.updatedAt}" class="ms-2 text-secondary">
                    (수정: <span th:text="${#temporals.format(board.updatedAt, 'yyyy-MM-dd HH:mm')}"></span>)
                </span>
            </div>
            <div>
                조회 <span th:text="${board.viewCount}">0</span>
            </div>
        </div>

        <!-- 본문 (줄바꿈 유지) -->
        <div class="board-content mb-5" style="white-space: pre-wrap;"
             th:text="${board.content}">
            내용
        </div>

        <!-- 첨부파일 - 10장에서 작성 -->
        <section class="mt-4 mb-4" th:if="${not #lists.isEmpty(board.attachments)}">
            <h6>첨부파일</h6>
            <ul class="list-group">
                <li class="list-group-item d-flex justify-content-between align-items-center"
                    th:each="file : ${board.attachments}">
                    <div>
                        <img th:if="${file.image}" th:src="@{/files/view/{id}(id=${file.id})}"
                             class="me-2" style="max-height: 50px;">
                        <span th:text="${file.originalFilename}">파일명</span>
                        <small class="text-muted ms-2"
                               th:text="${#numbers.formatDecimal(file.fileSize / 1024.0, 1, 1)} + ' KB'">
                            100 KB
                        </small>
                    </div>
                    <a th:href="@{/files/download/{id}(id=${file.id})}"
                       class="btn btn-sm btn-outline-secondary">다운로드</a>
                </li>
            </ul>
        </section>

        <!-- 버튼 -->
        <div class="d-flex justify-content-between">
            <a th:href="@{/boards}" class="btn btn-secondary">목록</a>
            <div sec:authorize="isAuthenticated()">
                <th:block th:if="${isOwner}">
                    <a th:href="@{/boards/{id}/edit(id=${board.id})}" class="btn btn-outline-primary">수정</a>
                    <button type="button" class="btn btn-outline-danger"
                            onclick="deleteBoard()">삭제</button>
                </th:block>
                <th:block th:if="${isAdmin and !isOwner}">
                    <button type="button" class="btn btn-outline-danger"
                            onclick="deleteBoard()">삭제 (관리자)</button>
                </th:block>
            </div>
        </div>
    </article>

    <!-- 댓글 영역 -->
    <section class="mt-5" id="comments-section">
        <h5>댓글 <span id="comment-count" class="badge bg-secondary">0</span></h5>

        <!-- 댓글 작성 폼 (로그인 사용자만) -->
        <form id="comment-form" class="mb-4" sec:authorize="isAuthenticated()">
            <div class="row g-2">
                <div class="col-md-10">
                    <input type="text" id="comment-content" class="form-control"
                           placeholder="댓글을 입력하세요" required>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">등록</button>
                </div>
            </div>
        </form>

        <!-- 비로그인 사용자 안내 -->
        <div sec:authorize="isAnonymous()" class="mb-4 text-center">
            <a th:href="@{/login}" class="btn btn-outline-primary">
                로그인하고 댓글 작성
            </a>
        </div>

        <!-- 댓글 목록 -->
        <div id="comment-list"></div>
    </section>
</main>

<th:block layout:fragment="script">
<script th:inline="javascript">
    const boardId = [[${board.id}]];
    const currentUsername = [[${currentUsername}]];
    const isOwner = [[${isOwner}]];
    const isAdmin = [[${isAdmin}]];

    document.addEventListener('DOMContentLoaded', function() {
        loadComments();
    });

    function loadComments() {
        fetch(`/api/boards/${boardId}/comments`)
            .then(response => response.json())
            .then(comments => {
                renderComments(comments);
                document.getElementById('comment-count').textContent = comments.length;
            })
            .catch(error => console.error('댓글 조회 실패:', error));
    }

    function renderComments(comments) {
        const container = document.getElementById('comment-list');
        if (comments.length === 0) {
            container.innerHTML = '<p class="text-muted">댓글이 없습니다.</p>';
            return;
        }
        container.innerHTML = comments.map(comment => `
            <div class="card mb-2" id="comment-${comment.id}">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${comment.writerName}</strong>
                            <small class="text-muted ms-2">${formatDate(comment.createdAt)}</small>
                        </div>
                        ${canEditComment(comment) ? `
                        <div>
                            <button class="btn btn-sm btn-outline-secondary me-1"
                                    onclick="editComment(${comment.id}, '${escapeHtml(comment.content)}')">수정</button>
                            <button class="btn btn-sm btn-outline-danger"
                                    onclick="deleteComment(${comment.id})">삭제</button>
                        </div>
                        ` : ''}
                    </div>
                    <p class="mb-0 mt-1">${comment.content}</p>
                </div>
            </div>
        `).join('');
    }

    function canEditComment(comment) {
        if (!currentUsername) return false;
        return comment.memberUsername === currentUsername || isAdmin;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('ko-KR', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
        });
    }

    // 댓글 작성 (CSRF 토큰 포함)
    const commentForm = document.getElementById('comment-form');
    if (commentForm) {
        commentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const content = document.getElementById('comment-content').value.trim();
            if (!content) {
                alert('내용을 입력해주세요.');
                return;
            }
            fetch(`/api/boards/${boardId}/comments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({ content })
            })
            .then(response => response.ok ? response.json() : Promise.reject())
            .then(() => {
                document.getElementById('comment-content').value = '';
                loadComments();
            })
            .catch(() => alert('댓글 등록에 실패했습니다.'));
        });
    }

    // 댓글 삭제 (CSRF 토큰 포함)
    function deleteComment(commentId) {
        if (!confirm('댓글을 삭제하시겠습니까?')) return;
        fetch(`/api/comments/${commentId}`, {
            method: 'DELETE',
            headers: { [csrfHeader]: csrfToken }
        })
        .then(response => response.ok ? loadComments() : Promise.reject())
        .catch(() => alert('댓글 삭제에 실패했습니다.'));
    }

    // 댓글 수정 (CSRF 토큰 포함)
    function editComment(commentId, currentContent) {
        const newContent = prompt('댓글을 수정하세요:', currentContent);
        if (newContent === null || newContent.trim() === '') return;
        fetch(`/api/comments/${commentId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify({ content: newContent.trim() })
        })
        .then(response => response.ok ? loadComments() : Promise.reject())
        .catch(() => alert('댓글 수정에 실패했습니다.'));
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // 게시글 삭제 (CSRF 토큰 포함)
    function deleteBoard() {
        if (confirm('정말 삭제하시겠습니까?')) {
            fetch(`/boards/${boardId}`, {
                method: 'DELETE',
                headers: { [csrfHeader]: csrfToken }
            })
            .then(response => {
                if (response.ok) {
                    alert('삭제되었습니다.');
                    location.href = '/boards';
                }
            });
        }
    }
</script>
</th:block>
</body>
</html>
