<!-- 수정: src/main/resources/templates/members/signup.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">

<head>
    <title>회원가입</title>
</head>

<body>
<main layout:fragment="content">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow">
                <div class="card-header">
                    <h4 class="mb-0">회원가입</h4>
                </div>
                <div class="card-body">
                    <form th:action="@{/members/signup}"
                          th:object="${signupRequest}" method="post">

                        <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger">
                            <span th:each="err : ${#fields.globalErrors()}" th:text="${err}"></span>
                        </div>

                        <div class="mb-3">
                            <label for="username" class="form-label">
                                아이디 <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="username"
                                   th:field="*{username}"
                                   th:classappend="${#fields.hasErrors('username')} ? 'is-invalid'"
                                   placeholder="영문 소문자, 숫자 4~20자">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('username')}"
                                 th:errors="*{username}"></div>
                        </div>

                        <div class="mb-3">
                            <label for="password" class="form-label">
                                비밀번호 <span class="text-danger">*</span>
                            </label>
                            <input type="password" class="form-control" id="password"
                                   th:field="*{password}"
                                   th:classappend="${#fields.hasErrors('password')} ? 'is-invalid'"
                                   placeholder="영문, 숫자, 특수문자 포함 8~20자">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('password')}"
                                 th:errors="*{password}"></div>
                        </div>

                        <div class="mb-3">
                            <label for="passwordConfirm" class="form-label">
                                비밀번호 확인 <span class="text-danger">*</span>
                            </label>
                            <input type="password" class="form-control" id="passwordConfirm"
                                   th:field="*{passwordConfirm}"
                                   th:classappend="${#fields.hasErrors('passwordConfirm')} ? 'is-invalid'">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('passwordConfirm')}"
                                 th:errors="*{passwordConfirm}"></div>
                        </div>

                        <div class="mb-3">
                            <label for="name" class="form-label">
                                이름 <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="name"
                                   th:field="*{name}"
                                   th:classappend="${#fields.hasErrors('name')} ? 'is-invalid'"
                                   placeholder="2~20자">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('name')}"
                                 th:errors="*{name}"></div>
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">이메일</label>
                            <input type="email" class="form-control" id="email"
                                   th:field="*{email}"
                                   th:classappend="${#fields.hasErrors('email')} ? 'is-invalid'"
                                   placeholder="example@email.com">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('email')}"
                                 th:errors="*{email}"></div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">가입하기</button>
                    </form>

                    <div class="text-center mt-3">
                        <span class="text-muted">이미 계정이 있으신가요?</span>
                        <a th:href="@{/login}">로그인</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // 아이디 중복 체크
    document.getElementById('username').addEventListener('blur', async function() {
        const username = this.value.trim();

        if (username.length < 4) {
            return;
        }

        try {
            const response = await fetch(`/members/check-username?username=${encodeURIComponent(username)}`);
            const available = await response.json();

            const usernameInput = document.getElementById('username');
            const feedback = usernameInput.nextElementSibling;

            if (!available) {
                usernameInput.classList.add('is-invalid');
                if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                    const div = document.createElement('div');
                    div.className = 'invalid-feedback';
                    div.style.display = 'block';
                    div.textContent = '이미 사용 중인 아이디입니다';
                    usernameInput.after(div);
                } else {
                    feedback.style.display = 'block';
                    feedback.textContent = '이미 사용 중인 아이디입니다';
                }
            } else {
                usernameInput.classList.remove('is-invalid');
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.style.display = 'none';
                }
            }
        } catch (error) {
            console.error('중복 체크 중 오류 발생:', error);
        }
    });

    // 이메일 중복 체크
    document.getElementById('email').addEventListener('blur', async function() {
        const email = this.value.trim();

        if (!email || email.length === 0) {
            return;
        }

        try {
            const response = await fetch(`/members/check-email?email=${encodeURIComponent(email)}`);
            const available = await response.json();

            const emailInput = document.getElementById('email');
            const feedback = emailInput.nextElementSibling;

            if (!available) {
                emailInput.classList.add('is-invalid');
                if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                    const div = document.createElement('div');
                    div.className = 'invalid-feedback';
                    div.style.display = 'block';
                    div.textContent = '이미 사용 중인 이메일입니다';
                    emailInput.after(div);
                } else {
                    feedback.style.display = 'block';
                    feedback.textContent = '이미 사용 중인 이메일입니다';
                }
            } else {
                emailInput.classList.remove('is-invalid');
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.style.display = 'none';
                }
            }
        } catch (error) {
            console.error('중복 체크 중 오류 발생:', error);
        }
    });

    // 비밀번호 확인 검증
    document.getElementById('passwordConfirm').addEventListener('input', function() {
        const password = document.getElementById('password').value;
        const passwordConfirm = this.value;

        const passwordConfirmInput = document.getElementById('passwordConfirm');
        let feedback = passwordConfirmInput.nextElementSibling;

        if (password !== passwordConfirm) {
            passwordConfirmInput.classList.add('is-invalid');
            if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                const div = document.createElement('div');
                div.className = 'invalid-feedback';
                div.style.display = 'block';
                div.textContent = '비밀번호가 일치하지 않습니다';
                passwordConfirmInput.after(div);
            } else {
                feedback.style.display = 'block';
                feedback.textContent = '비밀번호가 일치하지 않습니다';
            }
        } else {
            passwordConfirmInput.classList.remove('is-invalid');
            passwordConfirmInput.classList.add('is-valid');
            if (feedback && feedback.classList.contains('invalid-feedback')) {
                feedback.style.display = 'none';
            }
        }
    });
</script>
</body>
</html>
